name: Run Tests

on:
  - push

jobs:
  test-release:
    name: test-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [macos, linux, linux-arm]
        include:
          - build: macos
            os: macos-latest
            rust: nightly
            target: x86_64-apple-darwin
          - build: linux
            os: ubuntu-18.04
            rust: nightly
            target: x86_64-unknown-linux-musl
          - build: linux-arm
            os: ubuntu-18.04
            rust: nightly
            target: aarch64-unknown-linux-gnu
    steps:
      - name: Install Tasks
        uses: Arduino/actions/setup-taskfile@master
        with:
          version: "3"

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          override: true
          target: ${{ matrix.target }}
          components: clippy

      - name: Test
        run: |
          task test

      - name: Clippy
        run: |
          cargo clippy

      - name: Benchmarks
        run: |
          task benchmark
